{{ if ne .chezmoi.os "windows" -}}
#!/usr/bin/env bash

{{ includeTemplate "utils.sh" . }}

NAME="$(basename "$0")"
TERMINATE=true
TMPPACKAGES="/tmp/$(date +%s).packages.toml"

mpm "$@"

if [[ $1 =~ ^(install|upgrade|update|remove|uninstall)$ ]]; then
    TERMINATE=false
fi

if $TERMINATE; then
    exit $?
fi

mpm cleanup
mpm backup --overwrite "$TMPPACKAGES"

for m in "${MANAGERS[@]}"; do
    qq --output toml "{$m}" "$TMPPACKAGES" >"$PACKAGESPREFIX/${m}.toml"
done

chezmoi git add .
if [[ $1 =~ ^(upgrade|update)$ ]]; then
    chezmoi git commit -m 'chore: update packages'
else
    chezmoi git commit || emit i "Probably no changes to commit"
fi

if [[ $(chezmoi git -- branch --show-current) == master ]]; then
    chezmoi git push origin master
fi
{{- end -}}
{{/*
vim: filetype=sh.gotmpl
*/}}
