{{ if ne .chezmoi.os "windows" -}}
#!/usr/bin/env bash

source -p ~/bin utils.sh

NAME="$(basename "$0")"
TERMINATE=true
TMPPACKAGES="/tmp/$(date +%s).packages.toml"
OTHERPM=mpm

help() {
    cat <<EOF
Usage:
    $NAME [OPTION] [PACKAGE[ PACKAGE...]]

Options:
    {{ $packageManagerOptionsString }}
        Use the system package managers.
    --update
        Update all packages.
        Packages not managed by the system package managers will be updated with ${OTHERPM}.
    --$OTHERPM
        Use ${OTHERPM}.
    --help
        Show this help and exit.
    
Changes to packages are tracked by chezmoi.
EOF
}

post() {
    "$OTHERPM" cleanup
    "$OTHERPM" backup --overwrite "$TMPPACKAGES"

    for m in "${MANAGERS[@]}"; do
        qq --output toml "{$m}" "$TMPPACKAGES" >"$PACKAGESPREFIX/${m}.toml"
    done

    chezmoi git add .
    if (chezmoi git commit || emit i "Probably no changes to commit") && [[ $(chezmoi git -- branch --show-current) == master ]]; then
        chezmoi git push origin master
    fi
}

{{range $pm, $args := .packageManagers -}}
_{{ $pm }}() {
    {{ $args.command }} "$@"
    TERMINATE=false
}

{{ end -}}

update() {
    {{ range $pm, $args := .packageManagers -}}
    {{ if $args.update -}}
    {{ $args.command }} {{ includeTemplate "toShellArgs" $args.update }}

    {{ end -}}
    {{ $args.command }} {{ template "toShellArgs" $args.upgrade }}

    {{ end -}}
    xargs mpm <<EOF
{{ range .packageManagers | keys -}}
{{ printf "--no-%s" . }}
{{ end -}}
upgrade
EOF
    TERMINATE=false
}

chezmoi git add .
if [[ $1 =~ ^(upgrade|update)$ ]]; then
    chezmoi git commit -- -m 'chore: update packages' || emit i "Probably no changes to commit"
else
    chezmoi git commit || emit i "Probably no changes to commit"
fi

if [[ $(chezmoi git -- branch --show-current) == master ]]; then
    chezmoi git push origin master
fi
{{- end -}}
{{/*
vim: filetype=sh.gotmpl
*/}}
