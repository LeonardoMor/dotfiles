{{ if ne .chezmoi.os "windows" -}}
#!/usr/bin/env bash

source -p ~/bin utils.sh

NAME="$(basename "$0")"
TERMINATE=true
TMPPACKAGES="/tmp/$(date +%s).packages.toml"
OTHERPM=mpm

help() {
    cat <<EOF
Usage:
    ${NAME#*-} [OPTION] [PACKAGE[ PACKAGE...]]

Options:
    {{ $packageManagerOptionsString }}
        Use the system package managers. Changes to packages are tracked by chezmoi.
    --update
        Update all packages.
        Packages not managed by the system package managers will be updated with ${OTHERPM}.
    --$OTHERPM
        Use ${OTHERPM}. Changes to packages are tracked by chezmoi.
    --help
        Show this help and exit.
EOF
}

post() {
    "$OTHERPM" cleanup
    "$OTHERPM" backup --overwrite "$TMPPACKAGES"

    for m in "${MANAGERS[@]}"; do
        qq --output toml "{$m}" "$TMPPACKAGES" >"$PACKAGESPREFIX/${m}.toml"
    done

    chezmoi git add .
    if (chezmoi git commit || emit i "Probably no changes to commit") && [[ $(chezmoi git -- branch --show-current) == master ]]; then
        chezmoi git push origin master
    fi
}

{{range $pm, $args := .packageManagers -}}
_{{ $pm }}() {
    {{ $args.command }} "$@"
    TERMINATE=false
}

{{ end -}}

if $TERMINATE; then
    exit $?
fi

mpm cleanup
mpm backup --overwrite "$TMPPACKAGES"

for m in "${MANAGERS[@]}"; do
    qq --output toml "{$m}" "$TMPPACKAGES" >"$PACKAGESPREFIX/${m}.toml"
done

chezmoi git add .
if [[ $1 =~ ^(upgrade|update)$ ]]; then
    chezmoi git commit -- -m 'chore: update packages' || emit i "Probably no changes to commit"
else
    chezmoi git commit || emit i "Probably no changes to commit"
fi

if [[ $(chezmoi git -- branch --show-current) == master ]]; then
    chezmoi git push origin master
fi
{{- end -}}
{{/*
vim: filetype=sh.gotmpl
*/}}
