{{ if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash

FIXEDWRAPPERS=(
    game-performance
    prime-run
)

SCOPEBUDDY_FLAGS=()
GAME_ARGS=()

parse-args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -*)
                SCOPEBUDDY_FLAGS+=("$1")
                ;;
            *)
                GAME_ARGS+=("$1")
                ;;
        esac
        shift
    done
}

pre() {
    #    local hyprgamemode
    #    hyprgamemode="$(hyprctl -j getoption animations:enabled | jq -r '.set')"
    #    if $hyprgamemode; then
    #        hyprctl --batch "\
    #            keyword animations:enabled 0; \
    #            keyword animation borderangle,0: \
    #            keyword decoration:shadow:enabled 0;\
    #            keyword decoration:blur:enabled 0;\
    #            keyword decoration:fullscreen_opacity 1;\
    #            keyword general:gaps_in 0;\
    #            keyword general:gaps_out 0;\
    #            keyword general:border_size 1;\
    #            keyword decoration:rounding 0"
    #    fi
    systemctl --user stop kanata.service
    hyprctl dispatch exec -- \
        qs ipc call notification setDnD true
}

post() {
    systemctl --user start kanata.service
    hyprctl reload
    hyprctl dispatch exec -- \
        qs ipc call notification setDnD false
}

main() {
    parse-args "$@"
    pre
    trap post EXIT INT TERM

    local -a cmd=(
        "${FIXEDWRAPPERS[@]}"
        scopebuddy
        --nested-width 2560
        --nested-height 1440
        --nested-refresh 280
        --backend sdl
        --force-grab-cursor
        --mangoapp
        --adaptive-sync
        "${SCOPEBUDDY_FLAGS[@]}"
        --
        "${GAME_ARGS[@]}"
    )
    "${cmd[@]}"
}

main "$@"
{{- end -}}

{{/*
vim: filetype=sh.gotmpl
*/}}
